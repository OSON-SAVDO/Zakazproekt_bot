<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Сканер</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #reader { width: 100% !important; height: 30vh !important; background: #000; }
        #interface { flex-grow: 1; background: #fff; border-radius: 20px 20px 0 0; padding: 15px; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; }
        .btn { width: 35px; height: 35px; border-radius: 8px; border: none; color: #fff; font-size: 20px; }
        .btn-m { background: #e74c3c; } .btn-p { background: #2ecc71; }
    </style>
</head>
<body>
    <div id="reader"></div>
    <div id="interface" id="list">
        <div id="content"></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode'); // 'sale' ё 'receive'
    let cart = {};

    function onScanSuccess(code) {
        if (mode === 'receive') {
            // Агар режим ҚАБУЛ бошад, танҳо кодро ба бот мефиристем
            tg.sendData(code);
            tg.close();
        } else {
            // Агар ФУРӮШ бошад, дар экран нишон медиҳем
            fetchProduct(code);
        }
    }

    async function fetchProduct(code) {
        // ДАР ИНҶО URL-И РЕНДЕРИ ХУДРО МОНЕД
        const RENDER_URL = "https://zakazproekt-bot-2.onrender.com";
        try {
            const res = await fetch(`${RENDER_URL}/api/get_product`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code: code})
            });
            const data = await res.json();
            if(data.status === 'ok') {
                if(!cart[code]) cart[code] = {name: data.name, price: data.price, qty: 1};
                else cart[code].qty++;
                renderCart();
            }
        } catch(e) { alert("Хатогии пайвастшавӣ"); }
    }

    function renderCart() {
        const cont = document.getElementById('content');
        cont.innerHTML = '';
        Object.keys(cart).forEach(code => {
            const item = cart[code];
            cont.innerHTML += `<div class="item-row">
                <div><b>${item.name}</b><br>${item.price} смн</div>
                <div class="qty-ctrl">
                    <button class="btn btn-m" onclick="updateQty('${code}',-1)">-</button>
                    <b>${item.qty}</b>
                    <button class="btn btn-p" onclick="updateQty('${code}',1)">+</button>
                </div>
            </div>`;
        });
    }

    function updateQty(code, d) {
        cart[code].qty += d;
        if(cart[code].qty <= 0) delete cart[code];
        renderCart();
    }

    const scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, onScanSuccess);
</script>
</body>
</html>
