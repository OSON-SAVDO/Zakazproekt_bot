<!DOCTYPE html>
<html>
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #reader { height: 30%; background: black; }
        #product-list { height: 70%; overflow-y: auto; padding: 10px; background: #f4f4f4; }
        .product-item { display: flex; justify-content: space-between; background: white; padding: 10px; margin-bottom: 5px; border-radius: 8px; }
        .controls { display: flex; align-items: center; gap: 10px; }
        .btn { padding: 5px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-plus { background: #28a745; color: white; }
        .btn-minus { background: #dc3545; color: white; }
        #confirm-btn { position: fixed; bottom: 20px; right: 20px; padding: 15px; background: #007bff; color: white; border-radius: 50%; }
    </style>
</head>
<body>
    <div id="reader"></div>
    <div id="product-list">
        <h3>Маҳсулоти сканшуда:</h3>
        <div id="items"></div>
    </div>
    <button id="confirm-btn" onclick="sendData()">✅</button>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand(); // Кушодани экран ба пуррагӣ

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                // Вақте штрих-код хонда шуд
                addProductToList(decodedText);
            }
        );

        let cart = {};

        function addProductToList(code) {
            if (!cart[code]) {
                cart[code] = { name: "Мол #" + code, price: 0, qty: 1 };
            } else {
                cart[code].qty++;
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('items');
            container.innerHTML = '';
            for (let code in cart) {
                container.innerHTML += `
                    <div class="product-item">
                        <div>${cart[code].name}</div>
                        <div class="controls">
                            <button class="btn btn-minus" onclick="changeQty('${code}', -1)">-</button>
                            <span>${cart[code].qty}</span>
                            <button class="btn btn-plus" onclick="changeQty('${code}', 1)">+</button>
                        </div>
                    </div>`;
            }
        }

        function changeQty(code, delta) {
            cart[code].qty += delta;
            if (cart[code].qty <= 0) delete cart[code];
            renderCart();
        }

        function sendData() {
            tg.sendData(JSON.stringify(cart)); // Фиристодани маълумот ба бот
            tg.close();
        }
    </script>
</body>
</html>
