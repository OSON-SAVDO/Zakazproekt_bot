<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #scanner-container { position: relative; width: 100%; height: 40%; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-frame { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 220px; height: 130px; border: 2px solid #00ff00; border-radius: 10px; z-index: 5;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); pointer-events: none;
        }
        #interface { flex-grow: 1; background: white; color: black; border-radius: 20px 20px 0 0; padding: 15px; display: flex; flex-direction: column; }
        #status { font-size: 14px; text-align: center; color: #666; margin-bottom: 10px; }
        #items-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .total-box { border-top: 2px solid #333; padding: 10px 0; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .btn-torch { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.3); border: none; border-radius: 50%; width: 45px; height: 45px; color: white; font-size: 20px; z-index: 10; }
    </style>
</head>
<body>

<div id="scanner-container">
    <video id="video" playsinline muted autoplay></video>
    <div class="scan-frame"></div>
    <button id="btn-torch" class="btn-torch">üî¶</button>
</div>

<div id="interface">
    <div id="status">–ò–Ω—Ç–∏–∑–æ—Ä–∏ –∫–∞–º–µ—Ä–∞...</div>
    <div id="items-list"></div>
    <div class="total-box">
        <span>“∂–ê–ú–™:</span>
        <span><span id="total-sum">0.00</span> —Å–º–Ω</span>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const SERVER_URL = "https://zakazproekt-bot-2.onrender.com";

    let isScanning = false;
    let videoStream = null;

    async function initCamera() {
        const status = document.getElementById('status');
        try {
            // –ö”Ø—à–∏—à–∏ –≥–∏—Ä–∏—Ñ—Ç–∞–Ω–∏ –∫–∞–º–µ—Ä–∞
            const constraints = { video: { facingMode: "environment" } };
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById('video');
            video.srcObject = videoStream;
            
            status.innerText = "–ö–∞–º–µ—Ä–∞ –æ–º–æ–¥–∞ –∞—Å—Ç. –®—Ç—Ä–∏—Ö-–∫–æ–¥—Ä–æ –Ω–∞–∑–¥–∏–∫ –∫—É–Ω–µ–¥.";
            
            // –û“ì–æ–∑–∏ —Å–∫–∞–Ω–µ—Ä
            codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                if (result && !isScanning) {
                    isScanning = true;
                    if (navigator.vibrate) navigator.vibrate(100);
                    sendToApi(result.text);
                }
            });
        } catch (e) {
            status.innerHTML = "<b style='color:red;'>–•–∞—Ç–æ: –î–∞—Å—Ç—Ä–∞—Å”£ –±–∞ –∫–∞–º–µ—Ä–∞ —Ä–∞–¥ —à—É–¥!</b>";
            alert("–õ—É—Ç—Ñ–∞–Ω –¥–∞—Ä —Ç–∞–Ω–∑–∏–º–æ—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –±–∞ –¢–µ–ª–µ–≥—Ä–∞–º –∏“∑–æ–∑–∞—Ç–∏ –∫–∞–º–µ—Ä–∞ –¥–∏“≥–µ–¥.");
        }
    }

    async function sendToApi(barcode) {
        document.getElementById('status').innerText = "‚è≥ –î–∞—Ä “≥–æ–ª–∏ —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω...";
        try {
            const response = await fetch(`${SERVER_URL}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: barcode })
            });
            const data = await response.json();
            if (data.status === 'ok') {
                const list = document.getElementById('items-list');
                list.innerHTML = `<div class="item-row"><span>${data.name}</span><b>${data.price} —Å–º–Ω</b></div>` + list.innerHTML;
                let total = document.getElementById('total-sum');
                total.innerText = (parseFloat(total.innerText) + data.price).toFixed(2);
            }
        } catch (e) {
            console.error(e);
        } finally {
            setTimeout(() => { isScanning = false; document.getElementById('status').innerText = "–¢–∞–π—ë—Ä –±–∞—Ä–æ–∏ –º–æ–ª"; }, 2000);
        }
    }

    // –§–æ–Ω–∞—Ä–∏–∫
    document.getElementById('btn-torch').onclick = async () => {
        if (!videoStream) return;
        const track = videoStream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if (caps.torch) {
            const currentTorch = track.getSettings().torch;
            await track.applyConstraints({ advanced: [{ torch: !currentTorch }] });
        }
    };

    tg.ready();
    tg.expand();
    initCamera(); // –ö–∞–º–µ—Ä–∞—Ä–æ –¥–∞—Ä“≥–æ–ª –∫—É—à–æ–¥–∞–Ω
</script>
</body>
</html>
