<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∫–∞–Ω–µ—Ä–∏ –¢–µ–∑–∫–æ—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; color: white; }
        
        /* –ö–∞–º–µ—Ä–∞ –¥–∞—Ä —Ç–∞–º–æ–º–∏ —ç–∫—Ä–∞–Ω */
        #reader { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100% !important; 
            height: 100% !important; 
            object-fit: cover;
            z-index: 1;
        }

        /* –û—Ä–æ–∏—à–∏ —Ä”Ø–∏ –∫–∞–º–µ—Ä–∞ (–°–∫–∞–Ω-–∑–æ–Ω–∞) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2; pointer-events: none;
        }
        .scan-box {
            width: 250px; height: 250px;
            border: 2px solid #2ecc71;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
            border-radius: 20px; position: relative;
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px;
            background: #2ecc71; top: 0;
            animation: scanAnim 2s infinite linear;
        }
        @keyframes scanAnim {
            0% { top: 0; } 100% { top: 100%; }
        }

        /* –¢—É–≥–º–∞“≥–æ–∏ –∏–¥–æ—Ä–∞–∫—É–Ω”£ */
        .controls {
            position: fixed; top: 20px; width: 100%;
            display: flex; justify-content: space-around;
            z-index: 3; pointer-events: auto;
        }
        .mode-btn { 
            padding: 10px 20px; border-radius: 20px; border: none;
            font-weight: bold; color: white; cursor: pointer; opacity: 0.6;
        }
        .active { opacity: 1; transform: scale(1.1); box-shadow: 0 0 10px #fff; }
        
        .sound-toggle {
            position: fixed; bottom: 100px; right: 20px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            z-index: 3; pointer-events: auto; cursor: pointer; font-size: 24px;
        }

        /* –†”Ø–π—Ö–∞—Ç–∏ –º–æ–ª“≥–æ –¥–∞—Ä –ø–æ—ë–Ω */
        #cart-preview {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(255,255,255,0.9); color: black;
            border-radius: 20px 20px 0 0; padding: 15px;
            max-height: 30%; overflow-y: auto; z-index: 4;
            display: none; pointer-events: auto;
        }
    </style>
</head>
<body>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.mp3"></audio>

<div class="controls">
    <button id="btn-sale" class="mode-btn active" style="background: #27ae60;" onclick="changeMode('sale')">üõí –§–£–†”Æ–®</button>
    <button id="btn-receive" class="mode-btn" style="background: #2980b9;" onclick="changeMode('receive')">üì¶ “ö–ê–ë–£–õ</button>
</div>

<div id="reader"></div>

<div class="overlay">
    <div class="scan-box"><div class="scan-line"></div></div>
    <p id="hint">–°–∫–∞–Ω –∫—É–Ω–µ–¥...</p>
</div>

<div class="sound-toggle" onclick="toggleSound()">üîä</div>

<div id="cart-preview">
    <div id="items"></div>
    <div style="font-weight: bold; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 5px;">
        “∂–ê–ú–™: <span id="total-val">0</span> —Å–º–Ω
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let currentMode = 'sale';
    let isSoundOn = true;
    let cart = {};

    function toggleSound() {
        isSoundOn = !isSoundOn;
        document.querySelector('.sound-toggle').innerText = isSoundOn ? 'üîä' : 'üîà';
    }

    function changeMode(mode) {
        currentMode = mode;
        document.getElementById('btn-sale').classList.toggle('active', mode === 'sale');
        document.getElementById('btn-receive').classList.toggle('active', mode === 'receive');
        document.getElementById('cart-preview').style.display = (mode === 'sale' && Object.keys(cart).length > 0) ? 'block' : 'none';
        
        if (mode === 'receive') {
            tg.MainButton.hide();
        } else if (Object.keys(cart).length > 0) {
            tg.MainButton.show();
        }
    }

    function onScan(code) {
        if (isSoundOn) document.getElementById('beep').play();

        if (currentMode === 'receive') {
            // –ú–∞—ä–ª—É–º–æ—Ç—Ä–æ –±–∞ –±–æ—Ç –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º, —Ç–æ –±–æ—Ç –ø—É—Ä—Å–∞–¥: "–ù–æ–º, –ù–∞—Ä—Ö..."
            tg.sendData(JSON.stringify({action: 'receive', code: code}));
            tg.close();
        } else {
            // –§—É—Ä”Ø—à
            if (!cart[code]) {
                cart[code] = { name: "–ú–æ–ª " + code.substring(0,5), price: 10, qty: 1 };
            } else {
                cart[code].qty++;
            }
            updateUI();
        }
    }

    function updateUI() {
        const itemsDiv = document.getElementById('items');
        itemsDiv.innerHTML = '';
        let total = 0;
        
        for (let code in cart) {
            let item = cart[code];
            total += item.price * item.qty;
            itemsDiv.innerHTML += `<div>${item.name} x ${item.qty} = ${item.price * item.qty} —Å–º–Ω</div>`;
        }
        
        document.getElementById('total-val').innerText = total;
        document.getElementById('cart-preview').style.display = 'block';
        
        tg.MainButton.setText(`–¢–ê–°–î–ò“ö–ò –§–£–†”Æ–® (${total} —Å–º–Ω)`);
        tg.MainButton.show();
    }

    tg.MainButton.onClick(() => {
        tg.sendData(JSON.stringify({action: 'sale', items: cart}));
    });

    const scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScan);
</script>
</body>
</html>
