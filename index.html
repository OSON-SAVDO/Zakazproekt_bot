<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Сканери Осон-Савдо</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #f0f2f5; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 30% Сканер дар боло */
        #reader { width: 100% !important; height: 30vh !important; background: #000; }
        
        /* 70% Интерфейс дар поён */
        #interface { 
            height: 70vh; background: #fff; border-radius: 20px 20px 0 0; 
            padding: 15px; display: flex; flex-direction: column; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); 
        }
        
        #content { flex-grow: 1; overflow-y: auto; }
        
        .item-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border-bottom: 1px solid #eee; margin-bottom: 5px;
        }
        
        .qty-ctrl { display: flex; align-items: center; gap: 15px; }
        
        .btn-qty { 
            width: 35px; height: 35px; border-radius: 10px; border: none; 
            color: #fff; font-size: 20px; cursor: pointer; font-weight: bold;
        }
        .btn-m { background: #e74c3c; } 
        .btn-p { background: #2ecc71; }
        
        #checkout-btn { 
            width: 100%; background: #3498db; color: white; border: none; 
            padding: 15px; border-radius: 12px; font-size: 18px; font-weight: bold;
            margin-top: 10px; display: none;
        }

        /* Режими Қабул - Сканери пурра */
        .full-scanner #reader { height: 100vh !important; }
        .full-scanner #interface { display: none; }
    </style>
</head>
<body>
    <div id="reader"></div>
    <div id="interface">
        <div id="content">
            <p id="placeholder" style="text-align: center; color: #999; margin-top: 40px;">Рӯйхати молҳои сканшуда дар инҷо пайдо мешавад...</p>
        </div>
        <button id="checkout-btn" onclick="sendOrder()">✅ ТАСДИҚИ ФУРӮШ</button>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode'); 
    
    // !!! ИНҶОРО БО URL-И ХУД ИВАЗ КУНЕД !!!
    const SERVER_URL = "https://zakazproekt-bot-2.onrender.com"; 

    if (mode === 'receive') {
        document.body.classList.add('full-scanner');
    }

    let cart = {};

    function onScanSuccess(code) {
        if (mode === 'receive') {
            tg.sendData(JSON.stringify({action: 'receive', code: code}));
            tg.close();
        } else {
            fetchProduct(code);
        }
    }

    async function fetchProduct(code) {
        try {
            const res = await fetch(`${SERVER_URL}/api/get_product`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code: code})
            });
            const data = await res.json();
            
            if(data.status === 'ok') {
                if(!cart[code]) {
                    cart[code] = {name: data.name, price: data.price, qty: 1};
                } else {
                    cart[code].qty++;
                }
                renderCart();
            } else {
                alert("Мол дар база ёфт нашуд!");
            }
        } catch(e) {
            alert("Хатои пайвастшавӣ ба сервер!");
        }
    }

    function renderCart() {
        const cont = document.getElementById('content');
        const btn = document.getElementById('checkout-btn');
        cont.innerHTML = '';
        
        const keys = Object.keys(cart);
        if(keys.length > 0) {
            btn.style.display = 'block';
            keys.forEach(code => {
                const item = cart[code];
                cont.innerHTML += `
                    <div class="item-row">
                        <div><b>${item.name}</b><br><span style="color:#2ecc71">${item.price} смн</span></div>
                        <div class="qty-ctrl">
                            <button class="btn-qty btn-m" onclick="updateQty('${code}',-1)">-</button>
                            <b>${item.qty}</b>
                            <button class="btn-qty btn-p" onclick="updateQty('${code}',1)">+</button>
                        </div>
                    </div>`;
            });
        }
    }

    function updateQty(code, d) {
        cart[code].qty += d;
        if(cart[code].qty <= 0) delete cart[code];
        renderCart();
    }

    function sendOrder() {
        tg.sendData(JSON.stringify({action: 'sale', items: cart}));
        tg.close();
    }

    const scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
</script>
</body>
</html>
