<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { margin: 0; background: #f0f2f5; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* –†–µ–∂–∏–º–∏ –§—É—Ä”Ø—à (–ö–∞–º–µ—Ä–∞ –¥–∞—Ä –±–æ–ª–æ) */
        .mode-sale #scanner-wrapper { height: 35%; position: relative; background: #000; border-bottom: 2px solid #00ff00; }
        .mode-sale .scan-frame { width: 200px; height: 110px; border: 2px solid #00ff00; }

        /* –†–µ–∂–∏–º–∏ “ö–∞–±—É–ª (–ö–∞–º–µ—Ä–∞ –¥–∞—Ä —Ç–∞–º–æ–º–∏ —ç–∫—Ä–∞–Ω) */
        .mode-add #scanner-wrapper { height: 100vh; position: absolute; width: 100%; z-index: 10; }
        .mode-add .scan-frame { width: 260px; height: 260px; border: 4px solid #007bff; }
        .mode-add #interface { display: none; }

        #scanner-wrapper video { width: 100%; height: 100%; object-fit: cover; }
        .scan-frame { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 15px; z-index: 5; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); pointer-events: none;
        }

        #interface { flex-grow: 1; background: white; border-radius: 20px 20px 0 0; padding: 15px; display: flex; flex-direction: column; z-index: 11; margin-top: -15px; box-shadow: 0 -5px 10px rgba(0,0,0,0.1); }
        #status { font-size: 14px; text-align: center; color: #555; margin-bottom: 10px; font-weight: bold; min-height: 20px; }
        #items-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; background: #fff; animation: slideIn 0.3s ease; }
        .total-box { border-top: 3px solid #222; padding: 15px 0; font-size: 24px; font-weight: bold; display: flex; justify-content: space-between; color: #000; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body id="body" class="mode-sale">

<div id="scanner-wrapper">
    <video id="video" playsinline muted autoplay></video>
    <div class="scan-frame"></div>
</div>

<div id="interface">
    <div id="status">üîç –ò–Ω—Ç–∏–∑–æ—Ä–∏ —Å–∫–∞–Ω–µ—Ä...</div>
    <div id="items-list">
        </div>
    <div class="total-box">
        <span>“∂–ê–ú–™:</span>
        <span><span id="total-sum">0.00</span> —Å–º–Ω</span>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    
    // –°–£–†–û“í–ê–ò –°–ï–†–í–ï–†–ò –®–£–ú–û
    const SERVER_URL = "https://zakazproekt-bot-2.onrender.com"; 

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode'); // 'add' —ë null
    let isScanning = false;

    // –¢–∞–Ω–∑–∏–º–∏ –Ω–∞–º—É–¥–∏ –∑–æ“≥–∏—Ä”£ –≤–æ–±–∞—Å—Ç–∞ –±–∞ —Ç—É–≥–º–∞–∏ –ø–∞—Ö—à—à—É–¥–∞
    if (mode === 'add') {
        document.getElementById('body').className = 'mode-add';
    }

    async function initCamera() {
        try {
            const videoInputDevices = await codeReader.listVideoInputDevices();
            // –ò–Ω—Ç–∏—Ö–æ–±–∏ –∫–∞–º–µ—Ä–∞–∏ “õ–∞—Ñ–æ (–æ–¥–∞—Ç–∞–Ω –æ—Ö–∏—Ä–∏–Ω –¥–∞—Ä —Ä”Ø–π—Ö–∞—Ç)
            const selectedDeviceId = videoInputDevices[videoInputDevices.length - 1].deviceId;

            codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                if (result && !isScanning) {
                    isScanning = true;
                    if (navigator.vibrate) navigator.vibrate(100);
                    
                    if (mode === 'add') {
                        // –†–µ–∂–∏–º–∏ “ö–∞–±—É–ª: –¢–∞–Ω“≥–æ –∫–æ–¥—Ä–æ –±–∞ –±–æ—Ç –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º
                        tg.sendData(result.text); 
                    } else {
                        // –†–µ–∂–∏–º–∏ –§—É—Ä”Ø—à: –ë–∞ API-–∏ —Å–µ—Ä–≤–µ—Ä –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º
                        sendToApi(result.text);
                    }
                }
            });
        } catch (e) {
            document.getElementById('status').innerText = "–•–∞—Ç–æ –¥–∞—Ä –∫–∞–º–µ—Ä–∞!";
            console.error(e);
        }
    }

    async function sendToApi(barcode) {
        const status = document.getElementById('status');
        status.innerText = "‚è≥ “∂—É—Å—Ç—É“∑”Ø: " + barcode;
        
        try {
            const response = await fetch(`${SERVER_URL}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: barcode })
            });
            
            const data = await response.json();
            
            if (data.status === 'ok') {
                const list = document.getElementById('items-list');
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `<span>${data.name}</span><b>${data.price.toFixed(2)} —Å–º–Ω</b>`;
                list.prepend(row);
                
                let total = document.getElementById('total-sum');
                let newTotal = (parseFloat(total.innerText) + data.price).toFixed(2);
                total.innerText = newTotal;
                status.innerText = "‚úÖ –ú–æ–ª –∏–ª–æ–≤–∞ —à—É–¥";
            } else {
                status.innerHTML = `<span style="color:red;">‚ùå ${data.message}</span>`;
            }
        } catch (e) {
            status.innerHTML = `<span style="color:red;">‚ùå –•–∞—Ç–æ–∏ –ø–∞–π–≤–∞—Å—Ç –±–æ —Å–µ—Ä–≤–µ—Ä!</span>`;
        } finally {
            // –ë–∞—ä–¥–∏ 2 —Å–æ–Ω–∏—è —Å–∫–∞–Ω–µ—Ä—Ä–æ –±–æ–∑ —Ñ–∞—ä–æ–ª –º–µ–∫—É–Ω–µ–º
            setTimeout(() => { 
                isScanning = false; 
                if (mode !== 'add') status.innerText = "üîç –¢–∞–π—ë—Ä –±–∞—Ä–æ–∏ –º–æ–ª"; 
            }, 2000);
        }
    }

    tg.ready();
    tg.expand();
    initCamera();
</script>
</body>
</html>
