import telebot
from telebot import types
import sqlite3
from datetime import datetime

# 1. –¢–û–ö–ï–ù–ò –•–£–î–†–û –î–ê–† –ò–ù “∂–û –ì–£–ó–û–†–ï–î
TOKEN = '8560757080:AAFXJLy71LZTPKMmCiscpe1mWKmj3lC-hDE' 
bot = telebot.TeleBot(TOKEN)

# 2. –°–£–†–û“í–ê–ò –®–ê–•–°–ò–ò –®–£–ú–û –ê–ó GITHUB (–∫–∏ “≥–æ–∑–∏—Ä —Å–æ—Ö—Ç–µ–¥)
# –ú–∞—Å–∞–ª–∞–Ω: https://oson.github.io/Zakazproekt_bot/
SCANNER_URL = "–°–£–†–û“í–ê–ò_GITHUB_Pages_–®–£–ú–û"

# –°–æ—Ö—Ç–∞–Ω–∏ –ë–∞–∑–∞–∏ –º–∞—ä–ª—É–º–æ—Ç
def init_db():
    conn = sqlite3.connect('shop.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS products 
                      (barcode TEXT PRIMARY KEY, name TEXT, buy_price REAL, sell_price REAL)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS sales 
                      (id INTEGER PRIMARY KEY AUTOINCREMENT, barcode TEXT, qty INTEGER, date TEXT)''')
    conn.commit()
    conn.close()

init_db()

# –ú–µ–Ω—é–∏ –∞—Å–æ—Å”£ –±–æ —Ç—É–≥–º–∞“≥–æ
def main_markup():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    
    # –¢—É–≥–º–∞–∏ Web App –±–∞—Ä–æ–∏ —Å–∫–∞–Ω–µ—Ä–∏ —à–∞—Ö—Å–∏–∏ —à—É–º–æ
    web_app = types.WebAppInfo(SCANNER_URL)
    btn_scan = types.KeyboardButton("üì∏ –°–∫–∞–Ω–µ—Ä –≤–∞ –§—É—Ä”Ø—à", web_app=web_app)
    
    btn_report = types.KeyboardButton("üìä “≤–∏—Å–æ–±–æ—Ç–∏ –∏–º—Ä”Ø–∑–∞")
    btn_add = types.KeyboardButton("‚ûï –ò–ª–æ–≤–∞–∏ –º–∞“≥—Å—É–ª–æ—Ç")
    
    markup.add(btn_scan)
    markup.add(btn_report, btn_add)
    return markup

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(
        message.chat.id, 
        "–ë–æ—Ç –±–∞—Ä–æ–∏ –º–∞“ì–æ–∑–∞ —Ñ–∞—ä–æ–ª —à—É–¥!\n\n"
        "1. –ê–≤–≤–∞–ª –º–æ–ª—Ä–æ –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥.\n"
        "2. –ë–∞—ä–¥ –æ–Ω—Ä–æ —Å–∫–∞–Ω–µ—Ä –∫—É–Ω–µ–¥.", 
        reply_markup=main_markup()
    )

# “ö–∞–±—É–ª–∏ –º–∞—ä–ª—É–º–æ—Ç –∞–∑ –°–∫–∞–Ω–µ—Ä–∏ GitHub
@bot.message_handler(content_types=['web_app_data'])
def handle_scan(message):
    barcode = message.web_app_data.data
    conn = sqlite3.connect('shop.db')
    cursor = conn.cursor()
    cursor.execute("SELECT name, sell_price, buy_price FROM products WHERE barcode=?", (barcode,))
    product = cursor.fetchone()
    
    if product:
        name, sell, buy = product
        today = datetime.now().strftime("%Y-%m-%d")
        cursor.execute("INSERT INTO sales (barcode, qty, date) VALUES (?, ?, ?)", (barcode, 1, today))
        conn.commit()
        bot.send_message(message.chat.id, f"‚úÖ –§–£–†”Æ–•–¢–ê –®–£–î:\nüì¶ –ú–æ–ª: {name}\nüí∞ –ù–∞—Ä—Ö: {sell} —Å–æ–º–æ–Ω”£")
    else:
        bot.send_message(message.chat.id, f"‚ùå –ú–∞“≥—Å—É–ª–æ—Ç –±–æ –∫–æ–¥–∏ {barcode} –¥–∞—Ä –±–∞–∑–∞ –Ω–µ—Å—Ç.\n–ê–≤–≤–∞–ª –æ–Ω—Ä–æ –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥.")
    conn.close()

# “ö–∞–¥–∞–º–∏ 1: –û“ì–æ–∑–∏ –∏–ª–æ–≤–∞–∏ –º–∞“≥—Å—É–ª–æ—Ç
@bot.message_handler(func=lambda message: message.text == "‚ûï –ò–ª–æ–≤–∞–∏ –º–∞“≥—Å—É–ª–æ—Ç")
def add_product_start(message):
    msg = bot.send_message(
        message.chat.id, 
        "–ú–∞—ä–ª—É–º–æ—Ç—Ä–æ —á—É–Ω–∏–Ω —Ñ–∏—Ä–∏—Å—Ç–µ–¥ (–±–æ –≤–µ—Ä–≥—É–ª):\n`–ö–æ–¥, –ù–æ–º, –ù–∞—Ä—Ö–∏_–•–∞—Ä–∏–¥, –ù–∞—Ä—Ö–∏_–§—É—Ä”Ø—à` \n\n"
        "–ú–∏—Å–æ–ª:\n`358291, –õ–∞–∑–æ–ª–≤–∞–Ω, 50, 55`", 
        parse_mode="Markdown"
    )
    bot.register_next_step_handler(msg, process_add_product)

# “ö–∞–¥–∞–º–∏ 2: –°–∞–±—Ç –¥–∞—Ä –±–∞–∑–∞
def process_add_product(message):
    try:
        data = message.text.split(',')
        if len(data) < 4:
            raise ValueError
        
        barcode = data[0].strip()
        name = data[1].strip()
        buy = float(data[2].strip())
        sell = float(data[3].strip())
        
        conn = sqlite3.connect('shop.db')
        cursor = conn.cursor()
        cursor.execute("INSERT OR REPLACE INTO products VALUES (?, ?, ?, ?)", (barcode, name, buy, sell))
        conn.commit()
        conn.close()
        bot.send_message(message.chat.id, f"‚úÖ –ú–∞“≥—Å—É–ª–æ—Ç –∏–ª–æ–≤–∞ —à—É–¥: {name}")
    except:
        bot.send_message(message.chat.id, "‚ö†Ô∏è –•–∞—Ç–æ–≥”£! –ú–∞—ä–ª—É–º–æ—Ç—Ä–æ –¥—É—Ä—É—Å—Ç —Ñ–∏—Ä–∏—Å—Ç–µ–¥. –ú–∏—Å–æ–ª: 123, –ù–æ–º, 10, 15")

# “≤–∏—Å–æ–±–æ—Ç–∏ —Ñ—É—Ä”Ø—à –≤–∞ —Ñ–æ–∏–¥–∞
@bot.message_handler(func=lambda message: message.text == "üìä “≤–∏—Å–æ–±–æ—Ç–∏ –∏–º—Ä”Ø–∑–∞")
def get_report(message):
    today = datetime.now().strftime("%Y-%m-%d")
    conn = sqlite3.connect('shop.db')
    cursor = conn.cursor()
    
    query = '''
        SELECT SUM(p.sell_price), SUM(p.sell_price - p.buy_price)
        FROM sales s
        JOIN products p ON s.barcode = p.barcode
        WHERE s.date = ?
    '''
    cursor.execute(query, (today,))
    result = cursor.fetchone()
    conn.close()
    
    total_sales = result[0] if result[0] else 0
    total_profit = result[1] if result[1] else 0
    
    bot.send_message(
        message.chat.id, 
        f"üìä “≤–∏—Å–æ–±–æ—Ç–∏ –∏–º—Ä”Ø–∑–∞ ({today}):\n\n"
        f"üí∞ –§—É—Ä”Ø—à–∏ —É–º—É–º”£: {total_sales} —Å–æ–º–æ–Ω”£\n"
        f"üìà –§–æ–∏–¥–∞–∏ —Å–æ—Ñ: {total_profit} —Å–æ–º–æ–Ω”£"
    )

print("–ë–æ—Ç –¥–∞—Ä Pydroid 3 —Ñ–∞—ä–æ–ª —à—É–¥...")
bot.polling(none_stop=True)
