<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { margin: 0; background: #f4f4f9; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* –†–µ–∂–∏–º–∏ –§—É—Ä”Ø—à (–ö–∞–º–µ—Ä–∞–∏ —Ö—É—Ä–¥ –¥–∞—Ä –±–æ–ª–æ) */
        .mode-sale #scanner-container { height: 35%; position: relative; background: #000; }
        .mode-sale .scan-frame { width: 180px; height: 100px; border: 2px solid #00ff00; }

        /* –†–µ–∂–∏–º–∏ “ö–∞–±—É–ª (–ö–∞–º–µ—Ä–∞–∏ –∫–∞–ª–æ–Ω –¥–∞—Ä –±–∞–π–Ω–∏ —ç–∫—Ä–∞–Ω) */
        .mode-add #scanner-container { height: 100%; position: absolute; top: 0; left: 0; width: 100%; z-index: 10; }
        .mode-add .scan-frame { width: 250px; height: 250px; border: 4px solid #007bff; }
        .mode-add #interface { display: none; } /* –î–∞—Ä “≥–æ–ª–∞—Ç–∏ “õ–∞–±—É–ª –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ —Ñ—É—Ä”Ø—à –ª–æ–∑–∏–º –Ω–µ—Å—Ç */

        #scanner-container video { width: 100%; height: 100%; object-fit: cover; }
        .scan-frame { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 15px; z-index: 5; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); pointer-events: none;
        }

        #interface { flex-grow: 1; background: white; border-radius: 25px 25px 0 0; padding: 20px; display: flex; flex-direction: column; z-index: 11; position: relative; margin-top: -20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        #status { font-size: 14px; font-weight: bold; text-align: center; color: #555; margin-bottom: 10px; }
        #items-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; animation: fadeIn 0.3s; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; font-size: 16px; }
        .item-price { color: #28a745; font-size: 14px; }
        .total-box { border-top: 3px solid #333; padding-top: 15px; margin-top: 10px; font-size: 22px; font-weight: bold; display: flex; justify-content: space-between; color: #000; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="mode-sale" id="main-body">

<div id="scanner-container">
    <video id="video" playsinline muted autoplay></video>
    <div class="scan-frame"></div>
</div>

<div id="interface">
    <div id="status">üîç –¢–∞–π—ë—Ä –±–∞—Ä–æ–∏ —Å–∫–∞–Ω–µ—Ä...</div>
    <div id="items-list">
        </div>
    <div class="total-box">
        <span>“∂–ê–ú–™:</span>
        <span><span id="total-sum">0.00</span> —Å–º–Ω</span>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const SERVER_URL = "https://zakazproekt-bot-4.onrender.com"; // –°—É—Ä–æ“ì–∞–∏ Render-–∏ —à—É–º–æ

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode'); // 'add' —ë null
    let isScanning = false;

    // –¢–∞–Ω–∑–∏–º–∏ –Ω–∞–º—É–¥–∏ –∑–æ“≥–∏—Ä”£ –≤–æ–±–∞—Å—Ç–∞ –±–∞ —Ä–µ–∂–∏–º
    if (mode === 'add') {
        document.getElementById('main-body').className = 'mode-add';
    }

    async function initCamera() {
        try {
            const constraints = { video: { facingMode: "environment" } };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            document.getElementById('video').srcObject = stream;
            
            codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                if (result && !isScanning) {
                    isScanning = true;
                    if (navigator.vibrate) navigator.vibrate(100);
                    
                    if (mode === 'add') {
                        // –î–∞—Ä —Ä–µ–∂–∏–º–∏ “õ–∞–±—É–ª - —Ç–∞–Ω“≥–æ –∫–æ–¥—Ä–æ –±–∞ –±–æ—Ç –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º
                        tg.sendData(result.text); 
                    } else {
                        // –î–∞—Ä —Ä–µ–∂–∏–º–∏ —Ñ—É—Ä”Ø—à - –±–∞ —Å–µ—Ä–≤–µ—Ä –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º
                        sendToApi(result.text);
                    }
                }
            });
        } catch (e) {
            alert("–•–∞—Ç–æ–∏ –∫–∞–º–µ—Ä–∞: " + e);
        }
    }

    async function sendToApi(barcode) {
        document.getElementById('status').innerText = "‚è≥ “∂—É—Å—Ç—É“∑”Ø...";
        try {
            const response = await fetch(`${SERVER_URL}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: barcode })
            });
            const data = await response.json();
            
            if (data.status === 'ok') {
                const list = document.getElementById('items-list');
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${data.name}</span>
                        <span class="item-price">${data.price} —Å–º–Ω</span>
                    </div>
                    <b>${data.price} —Å–º–Ω</b>
                `;
                list.prepend(row);
                
                let total = document.getElementById('total-sum');
                total.innerText = (parseFloat(total.innerText) + data.price).toFixed(2);
                document.getElementById('status').innerText = "‚úÖ –ò–ª–æ–≤–∞ —à—É–¥!";
            } else {
                tg.showAlert("–•–∞—Ç–æ: " + data.message);
            }
        } catch (e) {
            console.error(e);
        } finally {
            setTimeout(() => { isScanning = false; document.getElementById('status').innerText = "üîç –¢–∞–π—ë—Ä –±–∞—Ä–æ–∏ –º–æ–ª"; }, 1500);
        }
    }

    tg.ready();
    tg.expand();
    initCamera();
</script>
</body>
</html>
