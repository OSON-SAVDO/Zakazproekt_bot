<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { margin: 0; background: #f4f4f7; color: #333; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* –î–∏–∑–∞–π–Ω–∏ –ö–∞–º–µ—Ä–∞ */
        #scanner-wrapper { position: relative; width: 100%; transition: all 0.3s; background: #000; }
        .sale-view { height: 35%; }
        .add-view { height: 100%; }
        
        video { width: 100%; height: 100%; object-fit: cover; }

        /* –†–∞–º–∫–∞ (–ß–æ—Ä–∫—É–Ω“∑–∞–∏ –º–∞–π–¥–∞) —Ç–∞–Ω“≥–æ –±–∞—Ä–æ–∏ —Ñ—É—Ä”Ø—à */
        .scan-frame { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 120px; border: 2px solid #00ff00; border-radius: 10px;
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); z-index: 5; display: none;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ –ø–æ—ë–Ω (–†”Ø–π—Ö–∞—Ç) */
        #interface { flex-grow: 1; background: white; border-radius: 20px 20px 0 0; padding: 15px; display: flex; flex-direction: column; z-index: 10; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        #items-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 8px; }
        .btn-del { color: #ff4d4d; border: 1px solid #ff4d4d; background: none; border-radius: 5px; padding: 5px 10px; font-weight: bold; }
        
        .total-box { border-top: 2px solid #333; padding-top: 10px; font-size: 20px; font-weight: bold; display: flex; justify-content: space-between; color: #2c3e50; }
        
        .controls { position: absolute; top: 10px; right: 10px; z-index: 20; }
        .btn-torch { background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; }
    </style>
</head>
<body>

<div id="scanner-wrapper">
    <video id="video" playsinline muted autoplay></video>
    <div id="frame" class="scan-frame"></div>
    <div class="controls">
        <button id="btn-torch" class="btn-torch">üî¶</button>
    </div>
</div>

<div id="interface">
    <div id="items-list"></div>
    <div id="total-area" class="total-box">
        <span>“∂–ê–ú–™:</span>
        <span><span id="total-sum">0.00</span> —Å–º–Ω</span>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const SERVER_URL = "https://zakazproekt-bot-2.onrender.com;

    const urlParams = new URLSearchParams(window.location.search);
    const isAddMode = urlParams.get('mode') === 'add';

    const wrapper = document.getElementById('scanner-wrapper');
    const interfaceDiv = document.getElementById('interface');
    const frame = document.getElementById('frame');

    if (isAddMode) {
        wrapper.className = "add-view";
        interfaceDiv.style.display = 'none';
        frame.style.display = 'none';
    } else {
        wrapper.className = "sale-view";
        frame.style.display = 'block';
    }

    // –û“ì–æ–∑–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∏ –∫–∞–º–µ—Ä–∞
    codeReader.decodeFromVideoDevice(undefined, 'video', (result, err) => {
        if (result) {
            if (navigator.vibrate) navigator.vibrate(100);
            if (isAddMode) {
                tg.sendData(result.text); // –°–∞“≥–∏—Ñ–∞ –±–∞—Å—Ç–∞ –º–µ—à–∞–≤–∞–¥
            } else {
                sendToApi(result.text);
            }
        }
    });

    async function sendToApi(barcode) {
        try {
            const response = await fetch(`${SERVER_URL}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: barcode })
            });
            const data = await response.json();
            if (data.status === 'ok') {
                const list = document.getElementById('items-list');
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `<div><b>${data.name}</b><br>${data.price} —Å–º–Ω</div>
                                 <button class="btn-del" onclick="removeItem(this, '${data.code}', ${data.price})">‚ùå</button>`;
                list.prepend(row);
                let total = document.getElementById('total-sum');
                total.innerText = (parseFloat(total.innerText) + data.price).toFixed(2);
            }
        } catch (e) { console.error(e); }
    }

    async function removeItem(btn, code, price) {
        const response = await fetch(`${SERVER_URL}/remove_item`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });
        if (response.ok) {
            btn.parentElement.remove();
            let total = document.getElementById('total-sum');
            total.innerText = (parseFloat(total.innerText) - price).toFixed(2);
        }
    }

    // –§–æ–Ω–∞—Ä–∏–∫
    let isTorchOn = false;
    document.getElementById('btn-torch').onclick = async () => {
        const stream = document.getElementById('video').srcObject;
        const track = stream.getVideoTracks()[0];
        isTorchOn = !isTorchOn;
        await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
    };

    tg.ready();
    tg.expand();
</script>
</body>
</html>
