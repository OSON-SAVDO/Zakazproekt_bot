<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #fff; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* –°–∫–∞–Ω–Ω–µ—Ä–∏ —Ö—É—Ä–¥ (30%) */
        #reader { width: 100% !important; height: 30vh !important; background: #000; }
        video { object-fit: cover !important; }

        /* –†”Ø–π—Ö–∞—Ç–∏ –º–æ–ª“≥–æ (70%) */
        #interface { flex-grow: 1; display: flex; flex-direction: column; background: #f8f9fa; border-radius: 20px 20px 0 0; padding: 15px; position: relative; z-index: 5; }
        
        #items-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* –¢—É–≥–º–∞–∏ –∫–∞–±—É–¥ –º–∞“≥–∑ –º—É–≤–æ—Ñ–∏“õ–∏ –∞–∫—Å–∏ —à—É–º–æ */
        .btn-receive { 
            width: 100%; padding: 16px; background: #3498db; color: white; 
            border: none; border-radius: 14px; font-size: 16px; font-weight: bold; 
            margin-top: 10px; cursor: pointer; transition: 0.2s;
        }
        .btn-receive.active { background: #2ecc71; } /* –†–∞–Ω–≥–∏ —Å–∞–±–∑ –≤–∞“õ—Ç–µ –∫–∏ —Ä–µ–∂–∏–º –∏–≤–∞–∑ –º–µ—à–∞–≤–∞–¥ */
    </style>
</head>
<body>

<audio id="beep-sound" preload="auto"><source src="https://www.soundjay.com/button/beep-07.mp3" type="audio/mpeg"></audio>

<div id="reader"></div>

<div id="interface">
    <div id="items-list">
        <p style="text-align: center; color: #999; margin-top: 20px;">–ú–æ–ª—Ä–æ —Å–∫–∞–Ω –∫—É–Ω–µ–¥...</p>
    </div>

    <button id="mode-btn" class="btn-receive" onclick="toggleMode()">üì¶ “ö–ê–ë–£–õ–ò –ë–û–†</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let mode = 'sale'; // –†–µ–∂–∏–º–∏ –∞–≤–≤–∞–ª–∏—è —Ñ—É—Ä”Ø—à –∞—Å—Ç
    let cart = {};

    function toggleMode() {
        const btn = document.getElementById('mode-btn');
        if (mode === 'sale') {
            mode = 'receive';
            btn.innerText = "üõí –†–ï–ñ–ò–ú–ò –§–£–†”Æ–®";
            btn.classList.add('active');
        } else {
            mode = 'sale';
            btn.innerText = "üì¶ “ö–ê–ë–£–õ–ò –ë–û–†";
            btn.classList.remove('active');
        }
    }

    async function onScanSuccess(decodedText) {
        document.getElementById('beep-sound').play().catch(() => {});
        
        // –ü–∞–π–≤–∞—Å—Ç –±–æ Python API
        try {
            const response = await fetch('https://YOUR-SERVER-URL.com/api/scan', { // –ò–Ω “∑–æ URL-–∏ main.py-—Ä–æ –º–æ–Ω–µ–¥
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code: decodedText, mode: mode })
            });
            const res = await response.json();
            
            if (res.status === 'ok') {
                updateUI(decodedText, res.name);
            } else {
                tg.showAlert(res.message);
            }
        } catch (e) {
            updateUI(decodedText, "–ú–æ–ª–∏ –Ω–∞–≤: " + decodedText.slice(-4));
        }
    }

    function updateUI(code, name) {
        if (!cart[code]) cart[code] = { name: name, qty: 0 };
        cart[code].qty++;
        render();
    }

    function render() {
        const list = document.getElementById('items-list');
        list.innerHTML = '';
        Object.keys(cart).forEach(c => {
            list.innerHTML += `<div class="item-row"><b>${cart[c].name}</b> <span>${cart[c].qty} –¥–æ–Ω–∞</span></div>`;
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: {width: 250, height: 100} }, onScanSuccess);
</script>
</body>
</html>
