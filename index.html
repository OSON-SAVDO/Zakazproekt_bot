<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { margin: 0; background: #f0f2f5; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .mode-sale #scanner-wrapper { height: 35%; position: relative; background: #000; border-bottom: 2px solid #00ff00; }
        .mode-sale .scan-frame { width: 200px; height: 110px; border: 2px solid #00ff00; }

        #scanner-wrapper video { width: 100%; height: 100%; object-fit: cover; }
        .scan-frame { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 15px; z-index: 5; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); pointer-events: none;
        }

        #interface { flex-grow: 1; background: white; border-radius: 20px 20px 0 0; padding: 15px; display: flex; flex-direction: column; z-index: 11; margin-top: -15px; box-shadow: 0 -5px 10px rgba(0,0,0,0.1); }
        #status { font-size: 14px; text-align: center; color: #555; margin-bottom: 10px; font-weight: bold; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-clear { flex: 2; background: #ff4757; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }
        /* –¢—É–≥–º–∞–∏ —Å–∞–¥–æ */
        .btn-sound { flex: 1; background: #2ed573; color: white; border: none; padding: 12px; border-radius: 10px; font-size: 18px; }

        #items-list { flex-grow: 1; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; }
        .total-box { border-top: 3px solid #222; padding: 10px 0; font-size: 22px; font-weight: bold; display: flex; justify-content: space-between; }
        
        /* –ë–∞—Ö—à–∏ –±–∞“õ–∏—è (—Å–¥–∞—á–∞) */
        .change-box { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 5px; }
        .change-input { width: 100%; padding: 8px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body id="body" class="mode-sale">

<audio id="beep-sound" preload="auto">
    <source src="https://www.soundjay.com/button/beep-07.mp3" type="audio/mpeg">
</audio>

<div id="scanner-wrapper">
    <video id="video" playsinline muted autoplay></video>
    <div class="scan-frame"></div>
</div>

<div id="interface">
    <div id="status">üîî –õ—É—Ç—Ñ–∞–Ω –∞–≤–≤–∞–ª —Ç—É–≥–º–∞–∏ üîä-—Ä–æ –ø–∞—Ö—à –∫—É–Ω–µ–¥!</div>
    
    <div class="controls">
        <button class="btn-clear" onclick="clearCheck()">üóë –¢–û–ó–ê –ö–ê–†–î–ê–ù</button>
        <button id="sound-init" class="btn-sound" onclick="enableSound()">üîä</button>
    </div>

    <div class="change-box">
        <input type="number" id="cash-received" class="change-input" placeholder="–ú–∞–±–ª–∞“ì–∏ –≥–∏—Ä–∏—Ñ—Ç–∞—à—É–¥–∞..." oninput="calcChange()">
        <div style="margin-top:5px; font-size: 14px; color: #2ecc71;"><b>–ë–∞“õ–∏—è (–°–¥–∞—á–∞): <span id="change-amount">0.00</span> —Å–º–Ω</b></div>
    </div>

    <div id="items-list"></div>
    
    <div class="total-box">
        <span>“∂–ê–ú–™:</span>
        <span><span id="total-sum">0.00</span> —Å–º–Ω</span>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const SERVER_URL = "https://zakazproekt-bot-2.onrender.com"; 

    const sound = document.getElementById('beep-sound');
    let isScanning = false;

    // –§–£–ù–ö–°–ò–Ø–ò –ú–£“≤–ò–ú: –ò“∑–æ–∑–∞—Ç–∏ —Å–∞–¥–æ
    function enableSound() {
        sound.play().then(() => {
            sound.pause();
            sound.currentTime = 0;
            document.getElementById('sound-init').style.background = "#747d8c";
            document.getElementById('status').innerText = "‚úÖ –°–∞–¥–æ —Ñ–∞—ä–æ–ª —à—É–¥! –°–∫–∞–Ω–µ—Ä –∫—É–Ω–µ–¥.";
        }).catch(e => console.log(e));
    }

    function playBeep() {
        sound.currentTime = 0;
        sound.play().catch(e => console.error("–°–∞–¥–æ –∫–æ—Ä –Ω–∞–∫–∞—Ä–¥:", e));
    }

    function calcChange() {
        const total = parseFloat(document.getElementById('total-sum').innerText);
        const received = parseFloat(document.getElementById('cash-received').value) || 0;
        const change = received - total;
        document.getElementById('change-amount').innerText = change > 0 ? change.toFixed(2) : "0.00";
    }

    function clearCheck() {
        if(confirm("–ß–µ–∫ —Ç–æ–∑–∞ —à–∞–≤–∞–¥?")) {
            document.getElementById('items-list').innerHTML = "";
            document.getElementById('total-sum').innerText = "0.00";
            document.getElementById('change-amount').innerText = "0.00";
            document.getElementById('cash-received').value = "";
        }
    }

    async function initCamera() {
        try {
            const videoInputDevices = await codeReader.listVideoInputDevices();
            const selectedDeviceId = videoInputDevices[videoInputDevices.length - 1].deviceId;

            codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                if (result && !isScanning) {
                    isScanning = true;
                    playBeep(); // –ü–∞—Ö—à–∏ —Å–∞–¥–æ
                    if (navigator.vibrate) navigator.vibrate(100);
                    sendToApi(result.text);
                }
            });
        } catch (e) {
            document.getElementById('status').innerText = "–•–∞—Ç–æ–∏ –∫–∞–º–µ—Ä–∞!";
        }
    }

    async function sendToApi(barcode) {
        try {
            const response = await fetch(`${SERVER_URL}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: barcode })
            });
            const data = await response.json();
            if (data.status === 'ok') {
                const list = document.getElementById('items-list');
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `<span>${data.name}</span><b>${data.price.toFixed(2)} —Å–º–Ω</b>`;
                list.prepend(row);
                
                let totalEl = document.getElementById('total-sum');
                totalEl.innerText = (parseFloat(totalEl.innerText) + data.price).toFixed(2);
                calcChange();
            }
        } finally {
            setTimeout(() => { isScanning = false; }, 2000);
        }
    }

    tg.ready();
    tg.expand();
    initCamera();
</script>
</body>
</html>
