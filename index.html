<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∫–∞–Ω–µ—Ä–∏ –¢–µ–∑–∫–æ—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; color: white; }
        #reader { position: fixed; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; pointer-events: none; }
        .scan-box { width: 250px; height: 250px; border: 3px solid #2ecc71; border-radius: 20px; position: relative; box-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #2ecc71; top: 0; animation: scanAnim 2s infinite linear; }
        @keyframes scanAnim { 0% { top: 0; } 100% { top: 100%; } }
        .controls { position: fixed; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 3; }
        .mode-btn { padding: 12px 25px; border-radius: 25px; border: none; font-weight: bold; color: white; cursor: pointer; transition: 0.3s; }
        .active { transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.5); border: 2px solid white; }
        #cart-preview { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); color: #333; border-radius: 20px 20px 0 0; padding: 15px; max-height: 40%; overflow-y: auto; z-index: 4; display: none; box-sizing: border-box; }
        .item-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.mp3" preload="auto"></audio>

<div class="controls">
    <button id="btn-sale" class="mode-btn active" style="background: #27ae60;" onclick="setMode('sale')">üõí –§–£–†”Æ–®</button>
    <button id="btn-receive" class="mode-btn" style="background: #2980b9;" onclick="setMode('receive')">üì¶ “ö–ê–ë–£–õ</button>
</div>

<div id="reader"></div>

<div class="overlay">
    <div class="scan-box"><div class="scan-line"></div></div>
    <p id="status-text" style="margin-top: 20px; font-weight: bold; text-shadow: 1px 1px 2px black;">–ö–∞–º–µ—Ä–∞—Ä–æ –±–∞ –∫–æ–¥ –Ω–∞–∑–¥–∏–∫ –∫—É–Ω–µ–¥</p>
</div>

<div id="cart-preview">
    <div id="items-list"></div>
    <div style="margin-top: 10px; font-size: 18px; font-weight: bold; text-align: right;">“∂–ê–ú–™: <span id="total-val">0</span> —Å–º–Ω</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let currentMode = 'sale';
    let cart = {};
    const beep = document.getElementById('beep');

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-sale').classList.toggle('active', mode === 'sale');
        document.getElementById('btn-receive').classList.toggle('active', mode === 'receive');
        updateUI();
    }

    function onScanSuccess(decodedText) {
        beep.play().catch(() => {});
        
        if (currentMode === 'receive') {
            // –î–∞—Ä —Ä–µ–∂–∏–º–∏ “õ–∞–±—É–ª —Ñ–∞–≤—Ä–∞–Ω –±–∞ –±–æ—Ç –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º
            tg.sendData(JSON.stringify({action: 'receive', code: decodedText}));
        } else {
            // –î–∞—Ä —Ä–µ–∂–∏–º–∏ —Ñ—É—Ä”Ø—à –±–∞ —Å–∞–±–∞–¥ –∏–ª–æ–≤–∞ –º–µ–∫—É–Ω–µ–º
            if (!cart[decodedText]) {
                cart[decodedText] = { name: "–ú–æ–ª " + decodedText.substring(0,4), price: 10, qty: 1 };
            } else {
                cart[decodedText].qty++;
            }
            updateUI();
        }
    }

    function updateUI() {
        const list = document.getElementById('items-list');
        const preview = document.getElementById('cart-preview');
        list.innerHTML = '';
        let total = 0;
        let count = 0;

        for (let id in cart) {
            let item = cart[id];
            total += item.price * item.qty;
            count++;
            list.innerHTML += `<div class="item-row"><span>${item.name} (x${item.qty})</span><span>${item.price * item.qty} —Å–º–Ω</span></div>`;
        }

        if (currentMode === 'sale' && count > 0) {
            preview.style.display = 'block';
            document.getElementById('total-val').innerText = total.toFixed(2);
            tg.MainButton.setText(`–¢–ê–°–î–ò“ö–ò –§–£–†”Æ–® (${total.toFixed(2)} —Å–º–Ω)`);
            tg.MainButton.show();
        } else {
            preview.style.display = 'none';
            tg.MainButton.hide();
        }
    }

    tg.MainButton.onClick(() => {
        tg.sendData(JSON.stringify({action: 'sale', items: cart}));
    });

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScanSuccess);
</script>
</body>
</html>
